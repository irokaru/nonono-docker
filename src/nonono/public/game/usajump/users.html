<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>うさじゃんぷ - 管理者向けユーザ確認ツール</title>
  <meta name="robots" content="noindex">
  <script src="https://unpkg.com/vue@next"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <style>
    table {
      border-collapse: collapse;
    }

    th {
      width: 180px;
    }

    th,td {
      border: solid 1px;
      padding: 10px;
    }

    td.color {
      text-align: center;
    }

    td.number {
      text-align: right;
    }
  </style>
</head>
<body>
  <div id="main">
    <p>レコード数：{{users.length}}</p>
    <p>ユニークユーザ数：{{arrayUnique(users, 'name').length}}</p>

    <table>
      <tr>
        <th>名前</th><th>色</th><th>ジャンプ力</th><th>角度</th><th>タイミング(frame)</th><th>登録日時</th>
      </tr>
      <tr v-for="user in users">
        <td>{{codeToKana(user.name)}}</td>
        <td class="color" :style="{'background-color': colorToStyle(user.color), 'color': fontColorAsBrightness(user.color)}">{{user.color}}</td>
        <td class="number">{{user.jump_power}}</td>
        <td class="number">{{user.jump_arc}}</td>
        <td class="number">{{user.jump_start_cnt}}</td>
        <td>{{user.created_at || '0000/00/00 00:00:00'}}</td>
      </tr>
    </table>
  </div>

  <script defer>
    const KANA = [
      ['あ', 'ぁ'], ['い', 'ぃ'], ['う', 'ぅ'], ['え', 'ぇ'], ['お', 'ぉ'],
      ['か', 'が'], ['き', 'ぎ'], ['く', 'ぐ'], ['け', 'げ'], ['こ', 'ご'],
      ['さ', 'ざ'], ['し', 'じ'], ['す', 'ず'], ['せ', 'ぜ'], ['そ', 'ぞ'],
      ['た', 'だ'], ['ち', 'ぢ'], ['つ', 'づ', 'っ', 'っ'], ['て', 'で'], ['と', 'ど'],
      ['な'], ['に'], ['ぬ'], ['ね'], ['の'],
      ['は', 'ば', 'ぱ'], ['ひ', 'び', 'ぴ'], ['ふ', 'ぶ', 'ぷ'], ['へ', 'べ', 'ぺ'], ['ほ', 'ぼ', 'ぽ'],
      ['ま'], ['み'], ['む'], ['め'], ['も'],
      ['や', 'ゃ'], ['ゆ', 'ゅ'], ['よ', 'ょ'],
      ['ら'], ['り'], ['る'], ['れ'], ['ろ'],
      ['わ'], ['を'], ['ん'],
    ];

    const users = {
      data() {
        return {
          users: [],
        };
      },
      methods: {
        async getUsers() {
          const api = axios.get('/game/usajump/score/score.json');
          this.users = await api.then(res => {
            return res.data;
          }).catch(e => {
            alert(e);
            return [];
          });
        },

        codeToKana(str) {
          let ret = '';

          for (const code of str.match(/.{3}/g)) {
            const number = code.slice(0, 2);
            const meta   = code.slice(-1);

            ret += KANA[Number(number)][meta];
          }

          return ret;
        },

        colorToStyle(color) {
          return `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
        },

        fontColorAsBrightness(color) {
          const brightness = Math.floor((parseInt(color[0], 16) * 0.299) +
                                        (parseInt(color[1], 16) * 0.587) +
                                        (parseInt(color[2], 16) * 0.114));
          return brightness >= 140 ? '#000000' : '#FFFFFF';
        },

        arrayUnique(array, key) {
          const ret = [];

          for (const item of array) {
            if (!ret.includes(item[key])) {
              ret.push(item[key]);
            }
          }

          return ret;
        }
      },
      created () {
        this.getUsers();
      },
    };
    Vue.createApp(users).mount('#main');
  </script>
</body>
</html>
